
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ЧатВтроем</title>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<style type="text/css">
	#own {
		color: green;
	}
	</style>
</head>
<body>
	<div class="container">
		<h3>ЧатВтроем <small>Для тех, кому скучно</small></h3>
		<button id="startButton" class="btn btn-success" onclick='startChat()'>Запустить</button><button class="btn btn-warning" onclick='restartChat()' style='margin-left: 5px'>Рестарт</button> <!--<button class="btn btn-info" onclick='exportLog()' style='margin-left: 5px'>Лог в .html</button>-->&nbsp;
		<input type="checkbox" id="autoreconnect" checked="" /> Автореконнект &nbsp;
		<input type="checkbox" id="autosender" checked="" /> Автопересылка
		<button class="btn btn-xs btn-warning pull-right" style='margin-left: 5px' data-toggle="popover" data-placement="bottom" data-content="Нашёл баг или хочешь предложить улучшение? Пиши на почту: namazov-nariman@inbox.ru

">?</button>&nbsp;
		<span class="pull-right">Статус: <span id="status">ожидание действия пользователя </span>&nbsp;</span>
		<div id="chatlog" class="panel panel-default" style='padding: 10px; margin-top: 10px; height: 460px; overflow-y: scroll'>
		</div>
		<nav class="navbar navbar-default navbar-fixed-bottom">
			<div class="row-fluid" style='margin-top: 7px'>
				<div class="col-md-8"><input id="messageText" type="text" class="form-control" /></div>
				<div class="col-md-2"><select id="chatId" class="form-control"><option value="0">Алиса</option><option value="1">Боб</option></select></div>
				<div class="col-md-2"><button class="btn btn-success" onclick='sendMessage()'>Отправить сообщение</button></div>
			</div>
		</nav>
	</div>
</body>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="base64.js?"></script>
<script type="text/javascript">
       var inv = ' ';
	$("[data-toggle='popover']").popover();
	function ChatLog($object) {
		this.object = $object;
	}
	ChatLog.prototype.addRow = function(type, message, id) {
		var labels = ['success', 'info', 'default'];
		var names = ['Алиса', 'Боб', 'System'];
		var appendId = (id !== undefined) ? id : '';
		if(message.indexOf(inv) > -1) {
			console.log('inv is here');
			message = message + " <span class='glyphicon glyphicon-flag' style='color:#ddd;' title='Анон.'></span>";
		}
		this.object.append('<div id="'+appendId+'" style="margin-top: 5px"><span class="label label-'+labels[type]+'">'+names[type]+'</span> '+message+'</div>');
	};
	ChatLog.prototype.clear = function() {
		this.object.html('');
	};
	var chatLogger = new ChatLog($("#chatlog"));
	var users = [];
	var chats = [];
	var guids = [];
	var autoSender = true;
	var autoReconnect = true;
	var chat = new WebSocket('wss://chatvdvoem.ru:9100');
	chat.onopen = function() {
		chatLogger.addRow(2, 'Подключено к серверам ЧатВдвоем');
	}
	chat.onmessage = function(evt) {
		var message = JSON.parse(evt.data);
		switch(message.action) {
			case 'user_connected':
				if (users.length != 2) {
					users.push(message.id);
					guids.push(message.guid);
				}
			break;
			case 'chat_connected':
				if (chats.length != 2) {
					chats.push(message.chat);
					connectUsers();
				}
			break;
			case 'message_from_user':
				if(message.chat == chats[0] || message.chat == chats[1]) {
					console.log(message);
					if (message.sender == "someone") {
						$("#writing").remove();
						if(autoSender) {
							sendAutomatic(message);
						}
					}
				}
			break;
			case 'chat_removed':
				closeChat();
				if(message.chat == chats[0] || message.chat == chats[1]) {
					chatLogger.addRow(2, 'Собеседник закрыл беседу');
					users = [];
					chats = [];
					if (autoReconnect) {
						chatLogger.clear();
						startChat();
					} else {
						$("#status").text('ожидание действия пользователя');
						$("#startButton").removeClass('disabled');
					}
				}
				
			break;
			case 'user_writing':
				$("#writing").remove();
				chatLogger.addRow(2, 'Собеседник пишет сообщение...', 'writing');
			break;
		}
	}
	function startChat() {
		users = [];
		chats = [];
		chatLogger.clear();
		connectUsers();
	}
	function exportLog() {
		var chatlog = document.getElementById("chatlog").innerHTML;
		var url = 'data:text/html;base64,'+Base64.encode('<!DOCTYPE HTML><head>	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>log</title></head><body>'+chatlog+'</body></html>');
		window.open(url);
	}
	function restartChat() {
		closeChat();
		setTimeout(function() { startChat(); }, 200);
	}
	function getReverseUser(chat) {
		return (chat == chats[0]) ? 1 : 0;
	}
	function sendAutomatic(message) {
		var rev = getReverseUser(message.chat);
		chat.send(JSON.stringify({
			action: "send_message",
			uid: users[rev],
			chat: chats[rev],
			guid: guids[rev],
			message: message.message
		}));
		chatLogger.addRow(rev, message.message);
	}
	function sendMessage() {
		var message = $("#messageText").val() + inv;
		chat.send(JSON.stringify({
			action:"send_message",
			uid: users[$("#chatId").val()],
			chat: chats[$("#chatId").val()],
			guid: chats[$("#chatId").val()],
			message: message
		}));
		chatLogger.addRow($("#chatId").val(), message, 'own');
		$("#messageText").val('');
	}
	function closeChat() {
		for (i in chats) {
			var socket = {
				action: "end_chat",
				uid: users[i],
				chat: chats[i],
				guid: guids[i]
			};
			chat.send(JSON.stringify(socket));
		}
	}
	function connectUsers() {
		if (chats.length != 2) {
			chat.send(JSON.stringify({"action": "user_connect"}));
		} else {
			chatLogger.addRow(2, 'ЧатВтроем подключен. Развлекайся, анон.');
			$("#status").text('Идёт общение');
			$("#startButton").addClass('disabled');
		}
		
	}
	$("#autosender").change(function() {
		autoSender = $(this).is(":checked");
	});
	$("#autoreconnect").change(function() {
		autoReconnect = $(this).is(":checked");
	});
	$(document).keypress(function(e) {
	    if(e.which == 13) {
	        sendMessage();
	    }
	});

	window.setInterval(function() {
  var elem = document.getElementById('chatlog');
  elem.scrollTop = elem.scrollHeight;
}, 100);
   //крысакун идёт нахуй
  if(typeof document.referrer !== 'undefined') {
     if(document.referrer !== '') {
        if(document.referrer.indexOf('2ch.') > -1) {
        }
        else {
           document.location.href = 'http://chatvdvoem.ru';
        }
     }
  }
	</script>
